import{e as c,d as f,M as w,l as _}from"./ZJ4Bl5jA.js";const k=120*1e3;class b{constructor(e){this._defaults=e,this._worker=null,this._client=null,this._idleCheckInterval=window.setInterval(()=>this._checkIfIdle(),30*1e3),this._lastUsedTime=0,this._configChangeListener=this._defaults.onDidChange(()=>this._stopWorker())}_stopWorker(){this._worker&&(this._worker.dispose(),this._worker=null),this._client=null}dispose(){clearInterval(this._idleCheckInterval),this._configChangeListener.dispose(),this._stopWorker()}_checkIfIdle(){if(!this._worker)return;Date.now()-this._lastUsedTime>k&&this._stopWorker()}_getClient(){return this._lastUsedTime=Date.now(),this._client||(this._worker=c.createWebWorker({moduleId:this._defaults.languageId,label:this._defaults.languageId,createData:{languageId:this._defaults.languageId}}),this._client=this._worker.getProxy()),this._client}getLanguageServiceWorker(...e){const s=e==null?void 0:e.filter(Boolean);return this._getClient().then(o=>(s&&(s!=null&&s.length)&&this._worker&&this._worker.withSyncedResources(s),o))}}function m(r,e,s){let o=null;return(...d)=>{o&&clearTimeout(o),o=setTimeout(()=>{o&&clearTimeout(o),o=null,r==null||r(...d)},e)}}class y{constructor(e,s,o){this._languageId=e,this._worker=s,this._defaults=o,this._disposables=[],this._listener=Object.create(null);const d=n=>{let t=n.getLanguageId();t===this._languageId&&(this._listener[n.uri.toString()]=n.onDidChangeContent(m(()=>{this._doValidate(n.uri,t)},500)),this._doValidate(n.uri,t))},a=n=>{c.setModelMarkers(n,this._languageId,[]);let t=n.uri.toString(),i=this._listener[t];i&&(i.dispose(),delete this._listener[t])};this._disposables.push(c.onDidCreateModel(d)),this._disposables.push(c.onWillDisposeModel(a)),this._disposables.push(c.onDidChangeModelLanguage(n=>{a(n.model),d(n.model)})),this._disposables.push(this._defaults.onDidChange(n=>{c.getModels().forEach(t=>{t.getLanguageId()===this._languageId&&(a(t),d(t))})})),this._disposables.push({dispose:()=>{for(let n in this._listener)this._listener[n].dispose()}}),c.getModels().forEach(d)}dispose(){this._disposables.forEach(e=>e&&e.dispose()),this._disposables=[]}_doValidate(e,s){this._worker(e).then(o=>{var d;let a=((d=c.getModel(e))===null||d===void 0?void 0:d.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(a=this._defaults.preprocessCode(a)),o.doValidation(a)}).then(o=>{const d=o.map(n=>A(e,n));let a=c.getModel(e);a&&a.getLanguageId()===s&&c.setModelMarkers(a,s,d)}).then(void 0,o=>{console.error(o)})}}function I(r){return w.Error}function A(r,e){return{severity:I(),startLineNumber:e.startLine,startColumn:e.startColumn,endLineNumber:e.endLine,endColumn:e.endColumn,message:e.message,code:void 0,source:"dt-sql-parser"}}class L{constructor(e,s){this._worker=e,this._defaults=s}get triggerCharacters(){return Array.isArray(this._defaults.triggerCharacters)?this._defaults.triggerCharacters:["."," "]}provideCompletionItems(e,s,o,d){const a=e.uri;return this._worker(a).then(n=>{var t;let i=((t=c.getModel(a))===null||t===void 0?void 0:t.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(i=this._defaults.preprocessCode(i)),n.doCompletionWithEntities(i,s)}).then(({suggestions:n,allEntities:t,context:i})=>{let g=[];return i!=null&&i.isStatementBeginning&&(g=this._defaults.completionSnippets.map(h=>Object.assign(Object.assign({},h),{insertText:typeof h.body=="string"?h.body:h.body.join(`
`)}))),this._defaults.completionService(e,s,o,n,t,g)}).then(n=>{const t=e.getWordUntilPosition(s),i=new f(s.lineNumber,t.startColumn,s.lineNumber,t.endColumn);return{suggestions:(Array.isArray(n)?n:n.suggestions).map(l=>{var u,p;return Object.assign(Object.assign({},l),{insertText:(u=l.insertText)!==null&&u!==void 0?u:typeof l.label=="string"?l.label:l.label.label,range:(p=l.range)!==null&&p!==void 0?p:i})}),dispose:Array.isArray(n)?void 0:n.dispose,incomplete:Array.isArray(n)?void 0:n.incomplete}})}}class M{constructor(e,s){this._worker=e,this._defaults=s}provideDefinition(e,s,o){const d=e.uri;return e.getLineContent(s.lineNumber).startsWith("--")?null:this._worker(d).then(n=>{let t=(e==null?void 0:e.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(t=this._defaults.preprocessCode(t)),n.getAllEntities(t)}).then(n=>{const t=e.getWordAtPosition(s);let i={line:-1,startColumn:-1,endColumn:-1};const g=n==null?void 0:n.find(h=>{const l=h.position;return l.startColumn===(t==null?void 0:t.startColumn)&&l.endColumn===(t==null?void 0:t.endColumn)&&l.line===s.lineNumber?h:null});if(g)for(let h in n){const l=n[Number(h)];if(l.entityContextType.includes("Create")&&(t!=null&&t.word)&&l.text===(t==null?void 0:t.word)&&l.entityContextType.includes(g.entityContextType)){i=l.position;break}}if(i&&i.line!==-1)return{uri:e.uri,range:new f(i==null?void 0:i.line,i==null?void 0:i.startColumn,i==null?void 0:i.line,i==null?void 0:i.endColumn)}})}}class W{constructor(e,s){this._worker=e,this._defaults=s}provideReferences(e,s,o,d){const a=e.uri;if(e.getLineContent(s.lineNumber).startsWith("CREATE"))return this._worker(a).then(t=>{let i=(e==null?void 0:e.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(i=this._defaults.preprocessCode(i)),t.getAllEntities(e==null?void 0:e.getValue())}).then(t=>{const i=e.getWordAtPosition(s),g=[],h=t==null?void 0:t.find(l=>{const u=l.position;return u.startColumn===(i==null?void 0:i.startColumn)&&u.endColumn===(i==null?void 0:i.endColumn)&&u.line===s.lineNumber?l:null});return h&&(t==null||t.forEach(l=>{if(i!=null&&i.word&&l.text===(i==null?void 0:i.word)&&h.entityContextType.includes(l.entityContextType)){let u=null;u=l.position,g.push({uri:e.uri,range:new f(u==null?void 0:u.line,u==null?void 0:u.startColumn,u==null?void 0:u.line,u==null?void 0:u.endColumn)})}})),g})}}function T(r){const e=[],s=[],o=new b(r);e.push(o);const d=(...n)=>o.getLanguageServiceWorker(...n);function a(){const{languageId:n,modeConfiguration:t}=r;C(s),t.diagnostics&&s.push(new y(n,d,r)),t.completionItems.enable&&s.push(_.registerCompletionItemProvider(n,new L(d,r))),t.references&&s.push(_.registerReferenceProvider(n,new W(d,r))),t.definitions&&s.push(_.registerDefinitionProvider(n,new M(d,r)))}return a(),e.push(v(s)),v(e)}function v(r){return{dispose:()=>C(r)}}function C(r){for(var e;r.length;)(e=r.pop())===null||e===void 0||e.dispose()}export{T as setupLanguageMode};
